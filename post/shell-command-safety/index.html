<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>Goç¨‹åºä¸­è°ƒç”¨Shellå‘½ä»¤ï¼šå¼•å‘çš„å®‰å…¨é—®é¢˜æ€è€ƒ | lrisğŸ€</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://lris0102.github.io/favicon.ico?v=1719911063243">
<link rel="stylesheet" href="https://lris0102.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="

Goç¨‹åºä¸­è°ƒç”¨shellå‘½ä»¤å®‰å…¨å—ï¼Ÿ
åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå› ä¸šåŠ¡åŠŸèƒ½çš„åŸå› åœ¨ç¼–å†™ç¨‹åºä¸­ç»å¸¸ä¼šè°ƒç”¨ç¬¬ä¸‰æ–¹å‘½ä»¤æˆ–ç³»ç»Ÿå‘½ä»¤æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ï¼Œä¸ç”±åœ¨æƒ³è¿™ç§æ–¹å¼çœŸçš„å®‰å…¨å—ï¼Ÿ
ç”±äºè¿™ç§ç–‘é—®è®©æˆ‘äº§ç”Ÿäº†æµ“çƒˆçš„å…´è¶£ï¼Œæœ¬æ¬¡å°†åˆ†æçš„ç»è¿‡è®°å½•äº†ä¸‹æ¥ã€‚æ¥ä¸‹æ¥å°ä¼™ä¼´ä»¬è·Ÿ..." />
    <meta name="keywords" content="go,shell" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://lris0102.github.io">
        <img src="https://lris0102.github.io/images/avatar.png?v=1719911063243" class="site-logo">
        <h1 class="site-title">lrisğŸ€</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            ç›®å½•
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      äº¢é¾™æœ‰æ‚”
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/lris0102" target="_blank"> lrisğŸ€</a> | <a class="rss" href="https://lris0102.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">Goç¨‹åºä¸­è°ƒç”¨Shellå‘½ä»¤ï¼šå¼•å‘çš„å®‰å…¨é—®é¢˜æ€è€ƒ</h2>
            <div class="post-date">2018-12-12</div>
            
            <div class="post-content" v-pre>
              <!-- more -->
<!-- more -->
<h1 id="goç¨‹åºä¸­è°ƒç”¨shellå‘½ä»¤å®‰å…¨å—">Goç¨‹åºä¸­è°ƒç”¨shellå‘½ä»¤å®‰å…¨å—ï¼Ÿ</h1>
<p>åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå› ä¸šåŠ¡åŠŸèƒ½çš„åŸå› åœ¨ç¼–å†™ç¨‹åºä¸­ç»å¸¸ä¼šè°ƒç”¨ç¬¬ä¸‰æ–¹å‘½ä»¤æˆ–ç³»ç»Ÿå‘½ä»¤æ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ï¼Œä¸ç”±åœ¨æƒ³è¿™ç§æ–¹å¼çœŸçš„å®‰å…¨å—ï¼Ÿ</p>
<p>ç”±äºè¿™ç§ç–‘é—®è®©æˆ‘äº§ç”Ÿäº†æµ“çƒˆçš„å…´è¶£ï¼Œæœ¬æ¬¡å°†åˆ†æçš„ç»è¿‡è®°å½•äº†ä¸‹æ¥ã€‚æ¥ä¸‹æ¥å°ä¼™ä¼´ä»¬è·Ÿæˆ‘ä¸€èµ·ç ”ç©¶å­¦ä¹ å§~</p>
<p>é¦–å…ˆï¼Œä¸‹é¢ä»£ç å—ä¸­ä½¿ç”¨äº†Goè¯­è¨€çš„ exec.Command çš„å‡½æ•°è¿›è¡Œæ‰§è¡Œ zip å‘½ä»¤å‹ç¼©æœ¬åœ°æ–‡ä»¶ã€‚å…¶ä¸­ -rP å‚æ•°ä»£è¡¨é€’å½’å‹ç¼©å¹¶è¿›è¡ŒåŠ å¯†ï¼Œå¯†ç abcd1234</p>
<figure data-type="image" tabindex="1"><img src="https://lris0102.github.io/post-images/1719902397753.png" alt="pic1" loading="lazy"></figure>
<p>å¾ˆå¤§éƒ¨åˆ†åœºæ™¯ä¸­ï¼Œåœ¨åšä¸šåŠ¡åŠŸèƒ½æ—¶æœ‰å¾ˆå¤šç±»ä¼¼çš„åšæ³•ã€‚ä¾‹å¦‚è¿›è¡Œæ‰§è¡ŒåŠ å¯†ã€è§£å¯†è¿‡ç¨‹ã€è·å–ç³»ç»ŸæŸäº›ä¿¡æ¯ç­‰ï¼Œä¹ æƒ¯æ€§è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ã€‚ä¸ºäº†æ¼”ç¤ºï¼Œåœ¨æ‰§è¡Œ zip å‘½ä»¤ä¹‹å‰ï¼ŒåŠ äº†å‘½ä»¤sleep 60 ç­‰å¾…ï¼Œåªæ˜¯ä¸ºäº†è®©å¤§å®¶æ›´å¥½çš„çœ‹åˆ°æ•ˆæœã€‚<br>
ä¸‹é¢é€šè¿‡go buildè¿›è¡Œç¼–è¯‘ï¼Œæ¥ç€è®©ç¼–è¯‘åçš„å‘½ä»¤è¿è¡Œèµ·æ¥ã€‚</p>
<pre><code class="language-shell">$ go build -o zipcommand main.go
$ ./zipcommand
</code></pre>
<h2 id="ç”¨æˆ·æ€å±‚é¢">ç”¨æˆ·æ€å±‚é¢</h2>
<p>æ¥è§¦è¿‡Linuxçš„å°ä¼™ä¼´è‚¯å®šé¦–å…ˆæƒ³åˆ°ä½¿ç”¨ ps å‘½ä»¤æ¥çœ‹è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://lris0102.github.io/post-images/1719556671793.png" alt="pic2" loading="lazy"></figure>
<p>å›¾ä¸­ï¼Œå…ˆå°†zipcommandè¿›ç¨‹PIDæ‰¾åˆ°ï¼Œç„¶åä½¿ç”¨pstreeå°†è¯¥è¿›ç¨‹æ ‘æ‰“å°ï¼Œå‘ç°goä¸­ exec.Command å‡½æ•°åœ¨è°ƒç”¨shellå‘½ä»¤æ—¶ä¼šfork()ä¸€ä¸ªå­è¿›ç¨‹æ‰§è¡Œã€‚ å°†ç¬¬ä¸€ä¸ªå­è¿›ç¨‹ 3648095 å±•å¼€COMMANDæ—¶ï¼Œå‘ç°shellä¸æˆ‘ä»¬åœ¨goä»£ç ä¸­ä¼ å…¥shellå‘½ä»¤æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·å°±å°†å‘½ä»¤è£¸éœ²åˆ°ç³»ç»Ÿå±‚é¢ä¸Šäº†ã€‚ å›¾ä¸­ç¬¬äºŒä¸ªå­è¿›ç¨‹ 3648096 æ˜¯å› ä¸ºä½¿ç”¨äº† &amp;&amp; æ‹¼æ¥ç¬¦ï¼Œåˆåˆ©ç”¨fork()å­è¿›ç¨‹æ–¹å¼å…ˆæ‰§è¡Œ sleep ååœ¨æ‰§è¡Œ zip å‘½ä»¤ã€‚<br>
è¿˜å¯ä»¥é€šè¿‡ /proc/pid/cmdline æ–¹å¼è¯»å– COMMAND è¿›ç¨‹å¯åŠ¨å‘½ä»¤ã€‚</p>
<p>æ³¨ï¼šè¿™é‡Œå¤§å®¶å¯ä»¥è¯¦ç»†æŸ¥çœ‹linuxè¿›ç¨‹fork()æœºåˆ¶çš„ææ–™ï¼Œæœ‰åŠ©äºåŠ æ·±ç†è§£ã€‚golangå°è£…çš„ exec.Command è¿™ç§æ–¹å¼æœ€ç»ˆä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨çœŸæ­£åœ¨åšå¤„ç†ã€‚</p>
<h2 id="ç³»ç»Ÿè°ƒç”¨å±‚é¢">ç³»ç»Ÿè°ƒç”¨å±‚é¢</h2>
<p>ä¸‹é¢æˆ‘åœ¨æƒ³ï¼Œç°åœ¨å·²ç»çŸ¥é“ç¨‹åºä¸­è°ƒç”¨shellå‘½ä»¤ä¼šæš´éœ²åœ¨ç³»ç»Ÿå±‚é¢ï¼Œé‚£ç¨‹åºåœ¨ exec.Command() ä¼ å…¥shellå‘½ä»¤åä¼šè¢«ç¯¡æ”¹å—ï¼Ÿ<br>
å¤§æ¦‚æ€è·¯æ˜¯ä½¿ç”¨ptrace()ç³»ç»Ÿè°ƒç”¨æ–¹å¼ï¼Œå…ˆæ‹¿åˆ°ç¨‹åºä¸­ä¼ å…¥çš„shellå‘½ä»¤å˜é‡å†…å­˜åœ°å€ï¼Œè¿›è¡Œå°è¯•ä¿®æ”¹å˜é‡å€¼ã€‚</p>
<p>ä¸Šé¢goç¨‹åºä¸­çš„å†…å­˜åœ°å€ä¸èƒ½ä¸cè¯­è¨€ç›´æ¥å¤„ç†ï¼Œä¸‹é¢ä¸¾ä¾‹å…ˆå…¨éƒ¨ä½¿ç”¨cè¯­è¨€ä»£ç æ¼”ç¤ºã€‚</p>
<p>ä»£ç ä¸­å°† cmd å†…å­˜åœ°å€ç›´æ¥è¾“å‡ºï¼Œè®©ptrace()å°è¯•ä¿®æ”¹å†…å­˜åœ°å€ï¼Œè¾¾åˆ°ç¯¡æ”¹è¿›ç¨‹è°ƒç”¨çš„ç›®çš„ã€‚é€šè¿‡ gcc cmd.c -o zipcommand è¿›è¡Œç¼–è¯‘ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://lris0102.github.io/post-images/1719556697960.png" alt="pic3" loading="lazy"></figure>
<p>ä¸‹é¢å°†zipcommandå‘½ä»¤è¿è¡Œï¼Œç„¶åæ‹¿åˆ°cmdå˜é‡çš„å†…å­˜åœ°å€ã€‚<br>
ptraceç¨‹åºå…³é”®ä»£ç </p>
<figure data-type="image" tabindex="4"><img src="https://lris0102.github.io/post-images/1719556732949.png" alt="pic4" loading="lazy"></figure>
<p>ä¸»è¦æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ptrace()æ–¹æ³•ï¼Œå…ˆattachåˆ°æŒ‡å®šè¿›ç¨‹ä¸Šï¼Œåœ¨åŸºäºæ‹¿åˆ°çš„å†…å­˜åœ°å€ï¼Œè¿›è¡Œä¿®æ”¹åè®©è¿›ç¨‹ç»§ç»­è¿è¡Œã€‚</p>
<p>æœ¬æ¬¡æ‰€ç”¨åˆ°ptrace()çš„ç±»å‹å¦‚ä¸‹ï¼š<br>
PTRACE_ATTACHæ˜¯ptrace()ä¸­attachåˆ°ä¸€ä¸ªæŒ‡å®šçš„è¿›ç¨‹ï¼Œä½¿å…¶æˆä¸ºå½“å‰è¿›ç¨‹è·Ÿè¸ªçš„å­è¿›ç¨‹ã€‚<br>
PTRACE_PEEKDATAå‘å†…å­˜åŒºåŸŸä¸­å†™å…¥ä¸€ä¸ªWORDï¼Œå†…å­˜åœ°å€ä¸ºaddrã€‚<br>
PTRACE_DETACHè¿›ç¨‹åœ¨æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨ä¹‹åæš‚åœã€‚</p>
<p>é€šè¿‡ gcc ptrace.c -o ptrace è¿›è¡Œç¼–è¯‘ã€‚ ä¸‹é¢å°è¯•ä½¿ç”¨ptraceå¯¹zipcommandå˜é‡å†…å­˜åœ°å€å°è¯•ç¯¡æ”¹ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° zipcommand ä¸­çš„cmdå˜é‡å€¼å·²ç»è¢«ç¯¡æ”¹æˆåŠŸã€‚<br>
ptrace.cè¯¦ç»†ä»£ç </p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/ptrace.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/reg.h&gt;
#include &lt;sys/syscall.h&gt;

int main(int argc, char* argv[])
{
    pid_t attack_pid;
 char cmd[] = &quot;echo helloword&quot;;
 if(argc != 2) {
        printf(&quot;Usage: %s &lt;pid to be traced&gt;
&quot;,
               argv[0]);
        exit(1);
    }
    attack_pid = atoi(argv[1]);
    if (ptrace(PTRACE_ATTACH, attack_pid, NULL, NULL) &lt; 0)
 {
  printf(&quot;attach failed
&quot;);
  return 0;
 }
 //è¯»æ•°æ®
 printf(&quot;stack_arg %d
&quot;, ptrace(PTRACE_PEEKDATA , attack_pid, (void*)0x7ffc41334450, NULL));
    //ä¿®æ”¹æ•°æ®
 putdata(attack_pid, (void*)0x7ffc41334450, cmd, 44);
 ptrace(PTRACE_DETACH, attack_pid, NULL, NULL);
 waitpid(attack_pid, NULL, WUNTRACED);
 return 0;
}

void putdata(pid_t child, long addr, char *str, int len) {
 char *laddr;
 int long_size = sizeof(long);
 int i, j;
 union u {
  long val;
  char chars[long_size];
 } data;

 i = 0;
 j = len / long_size;
 laddr = str;

 while (i &lt; j) {
  memcpy(data.chars, laddr, long_size);
  //æ¯æ¬¡å†™å…¥ä¸€ä¸ªå­—
  ptrace(PTRACE_POKEDATA, child, addr + i * 8, data.val);
  ++i;
  laddr += long_size;
 }
 j = len % long_size;
 if (j != 0) {
  memcpy(data.chars, laddr, j);
  ptrace(PTRACE_POKEDATA, child, addr + i * 8, data.val);
 }
}
</code></pre>
<p>ä¸Šé¢é€šè¿‡ä¸¤ä¸ªå±‚é¢ï¼Œè¯´æ˜äº†åœ¨ç¨‹åºä¸­è°ƒç”¨shellå‘½ä»¤çš„é¢ä¸´çš„é£é™©ã€‚ ä¸ºäº†è®©ç¨‹åºæ›´åŠ å®‰å…¨ï¼Œåº”å‡å°‘é‡‡ç”¨è°ƒç”¨shellå‘½ä»¤è¿™ç§æ–¹å¼ã€‚</p>

            </div>
            
              <div class="tag-container">
                
                  <a href="https://lris0102.github.io/tag/ZR9D9xJ9E/" class="tag">
                    go
                  </a>
                
                  <a href="https://lris0102.github.io/tag/uZ8meMWbH9/" class="tag">
                    shell
                  </a>
                
              </div>
            
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>




  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: 'Ov23lirrjrM4GXk4eeXD',
        clientSecret: '30daa1e52075efdb4b4fb9c711c3e1e8e299528f',
        repo: 'lris0102.github.io',
        owner: 'lris0102',
        admin: ['lris0102'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
